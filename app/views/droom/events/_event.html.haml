- @seen_events ||= []
- brief ||= false
- show_header ||= false
- event ||= @event
- full_attachments ||= false

- if event
  - event_master_id = event.master_id || event.id
  - if @seen_events[event_master_id]
    - repeating = true 
    - brief = true
  - @seen_events[event_master_id] = true;
  - cssclasses = ['event holder']
  - cssclasses << 'repeat' if repeating
  - cssclasses << 'private' if event.private?
  - cssclasses << 'public' if event.public?

  - if show_header 
    - header = month_header_for(event.start_date)
    - if header != @event_header
      %p.note
        = @event_header = header

  %div{:class => cssclasses.join(' ')}
    .datemark
      %span.mon= event.start.strftime('%b')
      %span.dom= event.start.strftime('%d')
      - if event.start.year != Date.today.year
        %span.year= event.start.strftime('%Y')

    .summary
      %h2.name<
        = link_to event.name, event_url(event)
        - if admin?
          = link_to t(:edit_event), edit_event_url(event), :class => 'admin edit minimal', :remote => true, :data => {:action => "overlay", :type => "html"}
        - else
          = link_to t(:download_ical), event_url(event, :format => :ics), :class => 'ical icon'

      - unless brief || full_attachments
        - if event.documents.any?
          .documents
            %h3 
              = link_to t(:attachments), '#', :title => t(:click_to_download_zipfile)
            %ul.downloads
              = render :partial => 'droom/documents/listing', :collection => event.documents.limit(3)
              - if event.documents.count > 3
                %li.more
                  = link_to t(:more_documents_count, :count => event.documents.count - 3), event_url(event)
      
      %p.practicalities
        %time
          = l(event.start_time, :format => :natural)
        - if event.venue
          %span.location
            = t(:at)
            - if event.venue.url
              = link_to event.venue.proper_name, event.venue.url
            - else
              = link_to event.venue.proper_name, venues_url(:id => event.venue.id)
              
      - unless brief
        = simple_format event.description, :class => "description"

  - if full_attachments
    - if event.document_attachments.any?
      .documents
        %h2
          = t :attachments
        = render :partial => "droom/events/attachment_list", :object => event.document_attachments.unfiled, :locals => {:limit => 100}

        - event.agenda_sections.each do |asec|
          - if asec.document_attachments.any?
            %h3
              = asec.name
            = render :partial => "droom/events/attachment_list", :object => asec.document_attachments, :locals => {:limit => 100}
  